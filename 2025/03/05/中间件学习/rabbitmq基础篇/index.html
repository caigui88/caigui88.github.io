<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>rabbitmq 基础篇 | Moru</title><meta name="author" content="moru"><meta name="copyright" content="moru"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="rabbitMQ 基础篇  参考资料： MQ入门-01.MQ课程介绍_哔哩哔哩_bilibili RabbitMQ 官方文档 RabbitMQ 常见问题与故障排查-CSDN博客 背景引入 一款高性能的异步通信组件 同步通信类似于：人和人之间打电话，没办法在同一时间和多个人打电话 异步通信类似于：人和人之间发微信，一个人可以同时和多个人进行聊天，并发能力强 原本的 openFegin 是一个同步操作">
<meta property="og:type" content="article">
<meta property="og:title" content="rabbitmq 基础篇">
<meta property="og:url" content="http://example.com/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/index.html">
<meta property="og:site_name" content="Moru">
<meta property="og:description" content="rabbitMQ 基础篇  参考资料： MQ入门-01.MQ课程介绍_哔哩哔哩_bilibili RabbitMQ 官方文档 RabbitMQ 常见问题与故障排查-CSDN博客 背景引入 一款高性能的异步通信组件 同步通信类似于：人和人之间打电话，没办法在同一时间和多个人打电话 异步通信类似于：人和人之间发微信，一个人可以同时和多个人进行聊天，并发能力强 原本的 openFegin 是一个同步操作">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png">
<meta property="article:published_time" content="2025-03-05T02:39:00.000Z">
<meta property="article:modified_time" content="2025-03-19T16:29:19.680Z">
<meta property="article:author" content="moru">
<meta property="article:tag" content="rabbitmq">
<meta property="article:tag" content="中间件">
<meta property="article:tag" content="基础篇">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "rabbitmq 基础篇",
  "url": "http://example.com/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/",
  "image": "https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png",
  "datePublished": "2025-03-05T02:39:00.000Z",
  "dateModified": "2025-03-19T16:29:19.680Z",
  "author": [
    {
      "@type": "Person",
      "name": "墨儒",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/butterfly-icon.png"><link rel="canonical" href="http://example.com/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'rabbitmq 基础篇',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(./img/sky.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/./img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011730967.png" alt="Logo"><span class="site-name">Moru</span></a><a class="nav-page-title" href="/"><span class="site-name">rabbitmq 基础篇</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">rabbitmq 基础篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-05T02:39:00.000Z" title="发表于 2025-03-05 10:39:00">2025-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-19T16:29:19.680Z" title="更新于 2025-03-20 00:29:19">2025-03-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="rabbitMQ-基础篇"><a class="header-anchor" href="#rabbitMQ-基础篇"></a>rabbitMQ 基础篇</h1>
<p><img src="" alt="RabbitMQ"></p>
<p>参考资料：</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1S142197x7?spm_id_from=333.788.player.switch&amp;bvid=BV1S142197x7&amp;vd_source=9fb105320442648b8c6fe466cf6f8b5c&amp;p=85">MQ入门-01.MQ课程介绍_哔哩哔哩_bilibili</a></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials">RabbitMQ 官方文档</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/web13508588635/article/details/144301392">RabbitMQ 常见问题与故障排查-CSDN博客</a></p>
<h2 id="背景引入"><a class="header-anchor" href="#背景引入"></a>背景引入</h2>
<p>一款高性能的异步通信组件</p>
<p>同步通信类似于：人和人之间打电话，没办法在同一时间和多个人打电话</p>
<p>异步通信类似于：人和人之间发微信，一个人可以同时和多个人进行聊天，并发能力强</p>
<p>原本的 openFegin 是一个同步操作，发送的请求必须实时等待返回结果，以下面的登录操作为例：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051042110.png" alt="image-20250305104252047"></p>
<p>修改成异步通信：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051043364.png" alt="image-20250305104356310"></p>
<p>只需要让其他的微服务监听到 MQ 的信息，而用户微服务可以让用户直接登录，无需过长时间等待</p>
<h2 id="初识MQ"><a class="header-anchor" href="#初识MQ"></a>初识MQ</h2>
<h3 id="同步调用"><a class="header-anchor" href="#同步调用"></a>同步调用</h3>
<p>以黑马商场的余额支付为例：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051050019.png" alt="image-20250305105049964"></p>
<p>业务分析：</p>
<ul>
<li>用户通过支付服务进行支付</li>
<li>支付服务调用用户服务进行用户余额的扣减
<ul>
<li>依据余额的扣减成功与否决定是否进行支付状态的更新，则此时需要使用同步调用</li>
</ul>
</li>
<li>支付服务调用交易服务，更订单状态，但由于交易服务并非强时效性的，因此并不是必须在支付服务完成任务后立刻进行的，所以可以采用异步调用，因此引入了异步调用。</li>
</ul>
<p>优点：</p>
<ul>
<li>时效性强（因为必须等待结果的返回）</li>
</ul>
<p>缺点：</p>
<ul>
<li>性能下降，因为必须等待结果返回，因此会发生阻塞</li>
<li>拓展性差</li>
</ul>
<h3 id="异步调用"><a class="header-anchor" href="#异步调用"></a>异步调用</h3>
<p>异步调用是指：程序发起一个操作后，不需要等待操作完成，而是继续执行后续代码。操作完成后，通过<strong>回调、事件或消息通知</strong>的方式返回结果。异步调用是<strong>非阻塞的</strong>，因为发起操作而无需等待操作的完成</p>
<h3 id="实现异步调用的方式："><a class="header-anchor" href="#实现异步调用的方式："></a>实现异步调用的方式：</h3>
<ol>
<li>多线程</li>
<li>回调函数</li>
<li>消息队列</li>
</ol>
<h3 id="基于消息队列实现的异步调用"><a class="header-anchor" href="#基于消息队列实现的异步调用"></a>基于消息队列实现的异步调用</h3>
<p>异步调用通常基于消息通知的方式，包含三个角色：</p>
<ul>
<li>消息发送者：投递消息，即服务调用者</li>
<li>消息接受者：接收和处理消息的人，即服务提供者</li>
<li>消息代理：管理、暂存、转发消息，中转站服务器</li>
</ul>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051102091.png" alt="image-20250305110229032"></p>
<p>以点外卖为例：用户下单，外卖员送外卖，但是为了防止用户有事无法立即拿外卖，所以外卖员可以把外卖暂时放在外卖柜，用户再监控外卖柜，查看外卖是否存在。</p>
<p>类似于计网里面路由的广播，发送者不关心接受者是谁，接受者不关心谁是发送者。</p>
<p>优势：</p>
<ul>
<li>解耦，具有高扩展性
<ul>
<li>因为生产者和消费者无需进行直接通信，可以通过消息代理来进行交互</li>
<li>而当有新的生产者或消费者时，只需要让生产者投递消息或消费者监听消息即可完成功能的扩展</li>
</ul>
</li>
<li>无需等待，性能好</li>
<li>故障隔离，防止级联失败</li>
<li>缓存消息，流量削峰填谷
<ul>
<li>在实际应用中考虑到服务集群，当消息代理具有大量消息时，由集群分别去消费消息代理里的信息，就不会造成服务负载的激增</li>
</ul>
</li>
</ul>
<p>缺点：</p>
<ul>
<li>时效性差，无法感知到消费者的状态，不知道最终结果</li>
<li>业务安全依赖于 Broker 的可靠性，一旦消息代理下线，服务会大规模失效</li>
</ul>
<p>应用场景：</p>
<ul>
<li>异步任务处理：常见的邮件发送、文件生成等</li>
<li>应用解耦：微服务之间通过消息队列进行通信，减少了关联性不强的服务之间的依赖</li>
<li>日志记录：将日志发送到啊消息队列，由专门的消费者进行处理，可以避免在本服务进行日志的记录</li>
</ul>
<h3 id="MQ-技术选型"><a class="header-anchor" href="#MQ-技术选型"></a>MQ 技术选型</h3>
<p>选择 rabbitMQ 的原因：</p>
<ul>
<li>虽然单机吞吐量一般。</li>
<li>长期而稳定的技术支持，开发 rabbitmq 的公司主要业务就是 rabbitmq，因此具有稳定的社区和技术支持。</li>
<li>使用的开发语言是 erlang，本身就是一种支持高并发的语言。</li>
<li>支持的协议丰富：支持SpringCloud默认支持的AMQP协议。</li>
<li>可用性和可靠性高。</li>
<li>消息延迟低。</li>
</ul>
<h3 id="rabbitmq-的整体架构及核心："><a class="header-anchor" href="#rabbitmq-的整体架构及核心："></a>rabbitmq 的整体架构及核心：</h3>
<p>virtual-host：虚拟主机，起到数据隔离的作用</p>
<ul>
<li>假设多个项目使用同一个 rabbitmq，则可以按项目构建不同的 virtual-host，进而让不同的项目的交换机和队列在各自的虚拟主机当中，起到数据隔离的作用。</li>
</ul>
<p>publisher：消息生产者</p>
<p>consumer：消息消费者</p>
<p>queue：队列，存储消息</p>
<p>exchange：交换机，负责路由消息</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051238628.png" alt="rabbitmq 的核心流程"></p>
<h3 id="rabbitmq-控制台的使用："><a class="header-anchor" href="#rabbitmq-控制台的使用："></a>rabbitmq 控制台的使用：</h3>
<p><strong>Exchanges 交换机</strong></p>
<p>点击 Exchanges，可以看到交换机列表</p>
<img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051255313.png" alt="image-20250305125500242" style="zoom:67%;" />
<p>点击某一个交换机进入交换机界面：</p>
<p>核心功能是 publish message，指的是发布消息：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051255649.png" alt="image-20250305125549588"></p>
<p>【注：交换机只能进行消息的转发而无法存储消息，即如果一个消息在交换机发布后未被路由，最终消息会丢失，而不是存储在交换机当中】</p>
<p><strong>Queues 队列</strong></p>
<p>点击 Queues，可以看到交换机列表</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051258320.png" alt="queues 列表"></p>
<p>点击任意一个队列进入：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051258751.png" alt="队列内存储的消息信息"></p>
<p><strong>Bindings</strong>：绑定当前队列可以接收到哪个交换机的发布的消息，这是一种发布订阅者模式，即发布者不关心到底谁得到了消息，而有需要的队列只需要去订阅相应的发布者即可得到消息</p>
<img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051259391.png" alt="image-20250305125917340" style="zoom:80%;" />
<h3 id="数据隔离"><a class="header-anchor" href="#数据隔离"></a>数据隔离</h3>
<p>创建用户，为用户创建一个命名与项目相关的 virtual host，</p>
<p>这样子登录不同的用户即可得到不同的虚拟主机</p>
<h2 id="SpringAMQP"><a class="header-anchor" href="#SpringAMQP"></a>SpringAMQP</h2>
<h3 id="yaml-文件配置"><a class="header-anchor" href="#yaml-文件配置"></a>yaml 文件配置</h3>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.246</span><span class="number">.129</span> <span class="comment"># 主机名</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> <span class="comment"># 端口</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/hmall</span> <span class="comment"># 虚拟主机</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">hmall</span> <span class="comment"># 用户名</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">hmall</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-amqp">Spring AMQP 官方文档</a></p>
<p>基于 AMQP 协议定义的一套 API 规范，提供了模板来发送和接收消息。包含两部分：spring-amqp 是基础抽象，spring-rabbit 是底层的默认实现。</p>
<h3 id="简单测试-rabbitmq"><a class="header-anchor" href="#简单测试-rabbitmq"></a>简单测试 rabbitmq</h3>
<p>消息发送者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> moru</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/3/5 下午1:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAmqpTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSimpleQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;simple.queue&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;hello,spring amqp!&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (count &lt; <span class="number">50</span>)&#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(queueName,msg);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>消息接受者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> moru</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/3/5 下午1:15</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListenRabbitMq</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">listenSimpleQueueMsg</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;监听的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="workQueues-模式"><a class="header-anchor" href="#workQueues-模式"></a>workQueues 模式</h2>
<p>WorkQueues 任务模型，让多个消费者绑定到一个队列，共同消费 队列中的消息</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051354816.png" alt="image-20250305135432748"></p>
<p>当消息处理比较耗时的时候，可能生产消息的速度远大于消费速度，长时间累计会导致消息无法被及时处理，可以使用 work 模型，多个消费者共同处理消息，消息处理的速度会随着消费者的增多而提高</p>
<h3 id="消息发送"><a class="header-anchor" href="#消息发送"></a>消息发送</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testWorkQueue</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;work.queue&quot;</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;hello,spring amqp!&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (count &lt; <span class="number">10</span>)&#123;</span><br><span class="line">    rabbitTemplate.convertAndSend(queueName,msg);</span><br><span class="line">    count++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="消息接收"><a class="header-anchor" href="#消息接收"></a>消息接收</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenSimpleQueueMsg1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">  log.info(<span class="string">&quot;消费者 1 监听的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;work.queue&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenSimpleQueueMsg2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">  log.error(<span class="string">&quot;消费者 2 监听的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试结果："><a class="header-anchor" href="#测试结果："></a>测试结果：</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">03-05 13:59:07:165  : 消费者 2 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:167  : 消费者 1 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:167  : 消费者 2 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:167  : 消费者 1 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:167  : 消费者 2 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:167  : 消费者 1 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:168  : 消费者 2 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:168  : 消费者 1 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:168  : 消费者 1 监听的信息为：hello,spring amqp!</span><br><span class="line">03-05 13:59:07:168  : 消费者 2 监听的信息为：hello,spring amqp!</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以从结果看出，消费机制类似于轮询（默认采用的是轮询机制）。也就是说消息是平均分配给每个消费者，并没有考虑到消费者的处理能力。</p>
<p>为了防止性能好的机器性能无法完全释放，可以修改 listen 配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span></span><br></pre></td></tr></table></figure>
<p>正所谓能者多劳，这样充分利用了每一个消费者的处理能力，可以有效避免消息积压问题。</p>
<h3 id="Work模型的使用"><a class="header-anchor" href="#Work模型的使用"></a>Work模型的使用</h3>
<ul>
<li>多个消费者绑定到一个队列，同一条消息只会被一个消费者处理</li>
<li>通过设置prefetch来控制消费者预取的消息数量</li>
</ul>
<h2 id="MQ交换机"><a class="header-anchor" href="#MQ交换机"></a>MQ交换机</h2>
<p>前面做的测试里面并没有引入交换机的概念，是生产者直接向消息队列发送消息以后消费者直接从队列当中获取，接下来要引入交换机，模式会有所变化：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051410983.png" alt="引入交换机的mq工作模式"></p>
<p>可以看到，在订阅模型中，多了一个exchange角色，而且过程略有变化：</p>
<ul>
<li><strong>Publisher</strong>：生产者，不再发送消息到队列中，而是发给交换机</li>
<li><strong>Exchange</strong>：交换机，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。
<ul>
<li><strong>接收</strong>生产者发送的消息。</li>
<li><strong>路由</strong>消息到与其绑定的队列。</li>
<li>发送者只需要发送一次消息，就可以被多个队列接收到，进而每一个微服务只关注自己的队列即可，不需要发送者把消息一个个发送到队列中</li>
</ul>
</li>
<li><strong>Queue</strong>：消息队列也与以前一样，接收消息、缓存消息。不过队列一定要与交换机绑定。</li>
<li><strong>Consumer</strong>：消费者，与以前一样，订阅队列，没有变化</li>
</ul>
<p><strong>Exchange（交换机）</strong> 只负责转发消息，不具备存储消息的能力，因此如果没有任何队列与 Exchange 绑定，或者没有符合路由规则的队列，那么消息会丢失！</p>
<h3 id="Fanout-交换机"><a class="header-anchor" href="#Fanout-交换机"></a>Fanout 交换机</h3>
<p>广播，将消息交给所有绑定到交换机的队列。我们最早在控制台使用的正是Fanout交换机</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051413106.png" alt="广播模式"></p>
<p>广播模式的流程为：</p>
<ol>
<li>可以有多个队列</li>
<li>每个队列都绑定到交换机上</li>
<li>生产者发送消息到交换机上</li>
<li>订阅了交换机消息的队列获取到消息</li>
<li>订阅了队列都消费者拿到队列中的消息</li>
</ol>
<blockquote>
<p>个人思考：“exchange” 并不主动发送消息给 xx 队列，因为绑定操作是由 queue 进行的，对于 exchange 来说它本身是无法感知到有什么 queue绑定了自己的，因此在 exchange 和 queue 之间有一个类似于“路由器”的机制，exchange 将消息发送给路由器之后再由路由器将消息分配给对应的 queue 。</p>
</blockquote>
<h4 id="消息发送-v2"><a class="header-anchor" href="#消息发送-v2"></a>消息发送</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testFanoutQueue</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;amq.fanout&quot;</span>;</span><br><span class="line">  <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;使用 fanout 交换机测试&quot;</span>;</span><br><span class="line"></span><br><span class="line">  rabbitTemplate.convertAndSend(exchangeName,<span class="literal">null</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="消息接收-v2"><a class="header-anchor" href="#消息接收-v2"></a>消息接收</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenExchangeQueueMsg1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者 1 监听 fanout.queue1 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;fanout.queue2&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenExchangeQueueMsg2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.error(<span class="string">&quot;消费者 2 监听 fanout.queue2 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试结果"><a class="header-anchor" href="#测试结果"></a>测试结果</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">03-05 14:54:19:041  ...: 消费者 1 监听 fanout.queue1 的信息为：使用 fanout 交换机测试</span><br><span class="line">03-05 14:54:19:041 ...: 消费者 2 监听 fanout.queue2 的信息为：使用 fanout 交换机测试</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Direct-交换机"><a class="header-anchor" href="#Direct-交换机"></a>Direct 交换机</h3>
<p>订阅，基于RoutingKey（路由key）发送给订阅了消息的队列</p>
<p>相较于 Fanout 多了一个验证消息的 Routingkey 和 BindingKey</p>
<ul>
<li>RoutingKey 由发布者指定</li>
<li>BindingKey 由 queue 设定</li>
<li>Exchange 将消息路由到 BindingKey 与 RoutingKey 一致的队列上。</li>
</ul>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051501057.png" alt="image-20250305150129983"></p>
<h4 id="消息发送-v3"><a class="header-anchor" href="#消息发送-v3"></a>消息发送</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testDirectExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;amq.direct&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;使用 direct 交换机测试&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">blue</span> <span class="operator">=</span> <span class="string">&quot;blue&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">yel</span> <span class="operator">=</span> <span class="string">&quot;yel&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">red</span> <span class="operator">=</span> <span class="string">&quot;red&quot;</span>;</span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,blue,blue + <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,yel,yel + <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,red,red + <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="消息接收-v3"><a class="header-anchor" href="#消息接收-v3"></a>消息接收</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenDirectQueueMsg1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者 1 监听 fanout.queue1 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue2&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenDirectQueueMsg2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.error(<span class="string">&quot;消费者 2 监听 fanout.queue2 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;direct.queue3&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenDirectQueueMsg3</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.error(<span class="string">&quot;消费者 3 监听 fanout.queue2 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="交换机绑定路由器如下"><a class="header-anchor" href="#交换机绑定路由器如下"></a>交换机绑定路由器如下</h4>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051513724.png" alt="image-20250305151331664"></p>
<h4 id="测试结果-v2"><a class="header-anchor" href="#测试结果-v2"></a>测试结果</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">03-05 15:11:46:904 	: 消费者 2 监听 fanout.queue2 的信息为：yel: 使用 direct 交换机测试</span><br><span class="line">03-05 15:11:46:904  : 消费者 1 监听 fanout.queue1 的信息为：blue: 使用 direct 交换机测试</span><br><span class="line">03-05 15:11:46:907 	: 消费者 2 监听 fanout.queue2 的信息为：red: 使用 direct 交换机测试</span><br><span class="line">03-05 15:11:46:907  : 消费者 1 监听 fanout.queue1 的信息为：red: 使用 direct 交换机测试</span><br></pre></td></tr></table></figure>
<p>由测试结果可以看出，只有发送的 RoutingKey 与 BindingKey 一致，exchange 才会转发给对应的 queue</p>
<h3 id="Topic-交换机"><a class="header-anchor" href="#Topic-交换机"></a>Topic 交换机</h3>
<p>通配符订阅，与Direct类似，只不过RoutingKey可以使用通配符</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051516602.png" alt="image-20250305151605524"></p>
<p>可以实现一种分组，根据某个字段进行分组分配。</p>
<h4 id="消息发送-v4"><a class="header-anchor" href="#消息发送-v4"></a>消息发送</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testTopicExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;amq.topic&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;使用 direct 交换机测试&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">c_w</span> <span class="operator">=</span> <span class="string">&quot;china.weather&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">c_n</span> <span class="operator">=</span> <span class="string">&quot;china.new&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">j_w</span> <span class="operator">=</span> <span class="string">&quot;japan.weather&quot;</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">j_n</span> <span class="operator">=</span> <span class="string">&quot;japan.new&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,c_w, c_w+ <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,c_n,c_n + <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,j_w, j_w+ <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">    rabbitTemplate.convertAndSend(exchangeName,j_n,j_n + <span class="string">&quot;: &quot;</span>+ msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="消息接收-v4"><a class="header-anchor" href="#消息接收-v4"></a>消息接收</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue1&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenTopicQueueMsg1</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者 1 监听 topic.queue1 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue2&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenTopicQueueMsg2</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.error(<span class="string">&quot;消费者 2 监听 topic.queue2 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;topic.queue3&quot;)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenTopicQueueMsg3</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;消费者 3 监听 topic.queue3 的信息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="交换机绑定如下"><a class="header-anchor" href="#交换机绑定如下"></a>交换机绑定如下</h4>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051523860.png" alt="image-20250305152358796"></p>
<h4 id="测试结果-v3"><a class="header-anchor" href="#测试结果-v3"></a>测试结果</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">03-05 15:23:20:666 ...: 消费者 2 监听 topic.queue2 的信息为：china.weather: 使用 direct 交换机测试</span><br><span class="line">03-05 15:23:20:666 ...: 消费者 1 监听 topic.queue1 的信息为：china.weather: 使用 direct 交换机测试</span><br><span class="line">03-05 15:23:20:671 ...: 消费者 1 监听 topic.queue1 的信息为：china.new: 使用 direct 交换机测试</span><br><span class="line">03-05 15:23:20:671 ...: 消费者 2 监听 topic.queue2 的信息为：japan.weather: 使用 direct 交换机测试</span><br><span class="line">03-05 15:23:20:673 ...: 消费者 2 监听 topic.queue2 的信息为：japan.new: 使用 direct 交换机测试</span><br><span class="line">03-05 15:23:20:673 ...: 消费者 1 监听 topic.queue1 的信息为：japan.new: 使用 direct 交换机测试</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="headers-交换机"><a class="header-anchor" href="#headers-交换机"></a>headers 交换机</h3>
<p>头匹配，基于MQ的消息头匹配，用的较少。</p>
<h2 id="声明队列和交换机"><a class="header-anchor" href="#声明队列和交换机"></a>声明队列和交换机</h2>
<p>在之前我们都是基于RabbitMQ控制台来创建队列、交换机。但是在实际开发时，队列和交换机是程序员定义的，将来项目上线，又要交给运维去创建。那么程序员就需要把程序中运行的所有队列和交换机都写下来，交给运维。在这个过程中是很容易出现错误的。</p>
<p>因此推荐的做法是由程序启动时检查队列和交换机是否存在，如果不存在自动创建。</p>
<p>（说白了就是用注解声明交换机和队列及绑定关系，如果控制台中不存在则创建，用代码代替了手动创建）</p>
<h3 id="基本API"><a class="header-anchor" href="#基本API"></a>基本API</h3>
<p>SpringAMQP 提供了一个 Queue 类，用来创建队列：</p>
<p>SpringAMQP 还提供了一个 Exchange 接口，来表示所有不同类型的交换机：</p>
<p>SpringAMQP 还提供了 ExchangeBuilder 来简化这个过程：</p>
<p>在绑定队列和交换机时，则使用 BindingBuilder 来创建 Binding 对象：</p>
<p>【注：一般来说都是由 consumer 创建 queue 和 exchange，因为在整个模式当中，发布者发布不发布消息对其本身业务来说并不影响，但消费者却需要消息队列和交换机来完成自身工作，因此一般在消费者创建】</p>
<h3 id="以-fanout-示例"><a class="header-anchor" href="#以-fanout-示例"></a>以 fanout 示例</h3>
<h4 id="基于-Bean-的方式声明队列和交换机"><a class="header-anchor" href="#基于-Bean-的方式声明队列和交换机"></a>基于 @Bean 的方式声明队列和交换机</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> moru</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2025/3/5 下午3:34</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fanout 交换机</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ExchangeBuilder.fanoutExchange(<span class="string">&quot;backend.fanout&quot;</span>).build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> Queue <span class="title function_">fanoutQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QueueBuilder.durable(<span class="string">&quot;backend-fanout.queue&quot;</span>).build();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="comment">// 这里直接按照 变量名 注入了 bean，所以不需要通过调用方法来获取参数</span></span><br><span class="line">  <span class="keyword">public</span> Binding <span class="title function_">fanoutBinding</span><span class="params">(Queue fanoutQueue, FanoutExchange fanoutExchange)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> BindingBuilder.bind(fanoutQueue).to(fanoutExchange);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="基于-RabbitListener-注解的方式来声明队列和交换机"><a class="header-anchor" href="#基于-RabbitListener-注解的方式来声明队列和交换机"></a>基于 @RabbitListener 注解的方式来声明队列和交换机</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">  value = @Queue(name = &quot;backend.annotate.fanout.queue&quot;),</span></span><br><span class="line"><span class="meta">  exchange = @Exchange(&quot;backend.annotate.fanout&quot;)</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenFanoutByBackend</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">  log.info(<span class="string">&quot;基于注解的方式，消费者监听 backend.annotate.fanout.queue 的消息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">  value = @Queue(name = &quot;backend.annotate.direct.queue&quot;),</span></span><br><span class="line"><span class="meta">  exchange = @Exchange(&quot;backend.annotate.direct&quot;),</span></span><br><span class="line"><span class="meta">  key = &#123;&quot;red&quot;,&quot;blue&quot;&#125;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">listenDirectByBackend</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">  log.info(<span class="string">&quot;基于注解的方式，消费者监听 backend.annotate.direct.queue 的消息为：&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="消息转换器"><a class="header-anchor" href="#消息转换器"></a>消息转换器</h2>
<p>Spring 对消息对象的处理是由 spring 默认提供的 MessageConverter 进行的，而默认实现的 SimpleMessageConverter，基于 JDK 的 ObjectOutputStream 完成序列化</p>
<p>这种默认提供的方法存在一些问题：</p>
<ul>
<li>
<p>JDK 序列化有安全风险：容易被代码注入</p>
</li>
<li>
<p>JDK 序列化后的消息体积太大，因为从原本字节较少的原始数据转换成了 byte 数据进行传输，假设原数据为: <code>&#123;“name”: “moru”, “age”: 22&#125;</code> 变成了一大串乱码 <code>rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAN3CAAAAAQAAAACdAAEbmFtZXQA BiBtb3J1IHQAA2FnZXNyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAW eA==</code>；</p>
</li>
<li>
<p>JDK 序列化的信息可读性差，乱码的不具有可读性</p>
</li>
</ul>
<h2 id="实际业务操作："><a class="header-anchor" href="#实际业务操作："></a>实际业务操作：</h2>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503051050019.png" alt="image-20250305105049964"></p>
<p>以黑马商场的 <em>支付-交易-用户</em> 为例：</p>
<p>在原本为引入 mq 的时候，支付模块需要通过 OpenFeign 来远程调用交易和用户模块的服务，这是一种同步机制，即支付模块必须等待被调用者的返回信息。</p>
<p>引入 rabbitmq 之后，我们进行了解耦：</p>
<p>在 pay 模块调用 rabbitmq 的自动装配的对象，使用该对象完成对特定队列的消息发送(本项目采用的转换器是 jackson，通过自动配置来在各个模块生效)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  rabbitTemplate.convertAndSend(exchange,routingKey,msg);</span><br><span class="line">&#125; <span class="keyword">catch</span>(AmqpException e)&#123;</span><br><span class="line">  log.error(<span class="string">&quot;发送支付状态消息失败，订单编号为:&#123;&#125;&quot;</span>,msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">墨儒</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/">http://example.com/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">转载请注明出处</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/rabbitmq/">rabbitmq</a><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="post-meta__tags" href="/tags/%E5%9F%BA%E7%A1%80%E7%AF%87/">基础篇</a></div><div class="post-share"><div class="social-share" data-image="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E9%AB%98%E7%BA%A7%E7%AF%87/" title="rabbitmq 高级篇"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">rabbitmq 高级篇</div></div><div class="info-2"><div class="info-item-1">rabbitmq 高级篇  假如 MQ 通知失败，那么会出现数据不一致的问题，此时就涉及到了消息可靠性（即消息至少被消费者处理过 1 次），接下来将介绍一些实践中常见的确保消息可靠性的手段 发送者可靠性 发送者重连 有时由于网络波动，可能出现发送者连接 MQ 失败的情况，此时通过配置可以开启连接失败后的重连机制： 123456789spring:  rabbitmq:    connection-timeout: 1s # 设置MQ的连接超时时间    template:      retry:        enabled: true # 开启超时重试机制        initial-interval: 1000ms # 失败后的初始等待时间        multiplier: 1 # 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier        max-attempts: 3 # 最大重试次数 【注：在网络存在不稳定的情况下，重试机制可以提高消息发送的成功率。但 SpringAMQP...</div></div></div></a><a class="pagination-related" href="/2025/03/04/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/docker-compose/" title="docker-compose"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200024740.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">docker-compose</div></div><div class="info-2"><div class="info-item-1">docker-compose 基本语法 docker-compose.yml文件的基本语法可以参考官方文档： https://docs.docker.com/compose/compose-file/compose-file-v3/ docker-compose文件中可以定义多个相互关联的应用容器，每一个应用容器被称为一个服务（service）。由于service就是在定义某个应用的运行时参数，因此与docker run参数非常相似。 举例来说，用docker run部署MySQL的命令如下： 12345678910docker run -d \  --name mysql \  -p 3306:3306 \  -e TZ=Asia/Shanghai \  -e MYSQL_ROOT_PASSWORD=123 \  -v ./mysql/data:/var/lib/mysql \  -v ./mysql/conf:/etc/mysql/conf.d \  -v ./mysql/init:/docker-entrypoint-initdb.d \  --network hmall...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E9%AB%98%E7%BA%A7%E7%AF%87/" title="rabbitmq 高级篇"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-05</div><div class="info-item-2">rabbitmq 高级篇</div></div><div class="info-2"><div class="info-item-1">rabbitmq 高级篇  假如 MQ 通知失败，那么会出现数据不一致的问题，此时就涉及到了消息可靠性（即消息至少被消费者处理过 1 次），接下来将介绍一些实践中常见的确保消息可靠性的手段 发送者可靠性 发送者重连 有时由于网络波动，可能出现发送者连接 MQ 失败的情况，此时通过配置可以开启连接失败后的重连机制： 123456789spring:  rabbitmq:    connection-timeout: 1s # 设置MQ的连接超时时间    template:      retry:        enabled: true # 开启超时重试机制        initial-interval: 1000ms # 失败后的初始等待时间        multiplier: 1 # 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier        max-attempts: 3 # 最大重试次数 【注：在网络存在不稳定的情况下，重试机制可以提高消息发送的成功率。但 SpringAMQP...</div></div></div></a><a class="pagination-related" href="/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/" title="es 基础篇"><img class="cover" src="/./img/3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-01</div><div class="info-item-2">es 基础篇</div></div><div class="info-2"><div class="info-item-1">Elasticsearch学习  官方文档，学习过程中遇到任何问题首先是尝试从官方文档中查找解决方法，同时也可以加深自己对技术特性的了解  Elasticsearch 生态丰富 elasticsearch 生态丰富，包含一系列工具和功能，帮助用户处理、分析和可视化数据， 核心组成为：  Elasticsearch：核心搜索引擎，负责存储、索引和搜索数据 Kibana：可视化平台、用于查询、分析和展示 Elasticsearch 中的数据 Logstash：数据处理管道，负责数据收集、过滤、增强和传输到 Elasticsearch。 Beats：轻量级的数据传输工具，收集和发生数据到 Logstash 或 Elasticsearch  核心概念  索引 index：类似于关系型数据库中的表，索引是数据存储和搜索的 基本单位，每个索引可以存储多条文档数据 文档 document：索引中的每条记录，类似于数据库中的行。以 json 格式存储 字段 field：文档中的每个键值对，类似于数据库中的列。 映射 mapping：（类似于 sql 建表语句）用于定义...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/./img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">moru</div><div class="author-info-description">道虽迩，不行不至</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">55</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/caigui88"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/caigui88" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="/1468664118@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#rabbitMQ-%E5%9F%BA%E7%A1%80%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">rabbitMQ 基础篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E5%BC%95%E5%85%A5"><span class="toc-number">1.1.</span> <span class="toc-text">背景引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E8%AF%86MQ"><span class="toc-number">1.2.</span> <span class="toc-text">初识MQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">同步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">异步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">实现异步调用的方式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">基于消息队列实现的异步调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ-%E6%8A%80%E6%9C%AF%E9%80%89%E5%9E%8B"><span class="toc-number">1.2.5.</span> <span class="toc-text">MQ 技术选型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rabbitmq-%E7%9A%84%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%A0%B8%E5%BF%83%EF%BC%9A"><span class="toc-number">1.2.6.</span> <span class="toc-text">rabbitmq 的整体架构及核心：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rabbitmq-%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%9A"><span class="toc-number">1.2.7.</span> <span class="toc-text">rabbitmq 控制台的使用：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB"><span class="toc-number">1.2.8.</span> <span class="toc-text">数据隔离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringAMQP"><span class="toc-number">1.3.</span> <span class="toc-text">SpringAMQP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yaml-%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">yaml 文件配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95-rabbitmq"><span class="toc-number">1.3.2.</span> <span class="toc-text">简单测试 rabbitmq</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#workQueues-%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">workQueues 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="toc-number">1.4.1.</span> <span class="toc-text">消息发送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6"><span class="toc-number">1.4.2.</span> <span class="toc-text">消息接收</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C%EF%BC%9A"><span class="toc-number">1.4.3.</span> <span class="toc-text">测试结果：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Work%E6%A8%A1%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.4.4.</span> <span class="toc-text">Work模型的使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MQ%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.5.</span> <span class="toc-text">MQ交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Fanout-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.5.1.</span> <span class="toc-text">Fanout 交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81-v2"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">消息发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6-v2"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">消息接收</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Direct-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.5.2.</span> <span class="toc-text">Direct 交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81-v3"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">消息发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6-v3"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">消息接收</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E8%B7%AF%E7%94%B1%E5%99%A8%E5%A6%82%E4%B8%8B"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">交换机绑定路由器如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-v2"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Topic-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.5.3.</span> <span class="toc-text">Topic 交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81-v4"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">消息发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6-v4"><span class="toc-number">1.5.3.2.</span> <span class="toc-text">消息接收</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E5%A6%82%E4%B8%8B"><span class="toc-number">1.5.3.3.</span> <span class="toc-text">交换机绑定如下</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-v3"><span class="toc-number">1.5.3.4.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#headers-%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.5.4.</span> <span class="toc-text">headers 交换机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.6.</span> <span class="toc-text">声明队列和交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%ACAPI"><span class="toc-number">1.6.1.</span> <span class="toc-text">基本API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5-fanout-%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.6.2.</span> <span class="toc-text">以 fanout 示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-Bean-%E7%9A%84%E6%96%B9%E5%BC%8F%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.6.2.1.</span> <span class="toc-text">基于 @Bean 的方式声明队列和交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-RabbitListener-%E6%B3%A8%E8%A7%A3%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%A3%B0%E6%98%8E%E9%98%9F%E5%88%97%E5%92%8C%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-number">1.6.2.2.</span> <span class="toc-text">基于 @RabbitListener 注解的方式来声明队列和交换机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8"><span class="toc-number">1.7.</span> <span class="toc-text">消息转换器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E4%B8%9A%E5%8A%A1%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-number">1.8.</span> <span class="toc-text">实际业务操作：</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/18/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/" title="算法"><img src="/./img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法"/></a><div class="content"><a class="title" href="/2025/03/18/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/" title="算法">算法</a><time datetime="2025-03-18T12:43:53.000Z" title="发表于 2025-03-18 20:43:53">2025-03-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/14/MySQL/MySql%E8%BF%9B%E9%98%B6/" title="MySql进阶"><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200028085.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySql进阶"/></a><div class="content"><a class="title" href="/2025/03/14/MySQL/MySql%E8%BF%9B%E9%98%B6/" title="MySql进阶">MySql进阶</a><time datetime="2025-03-14T06:08:13.000Z" title="发表于 2025-03-14 14:08:13">2025-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/07/Java%E5%9F%BA%E7%A1%80/IO%E6%B5%81/" title="IO流"><img src="/./img/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="IO流"/></a><div class="content"><a class="title" href="/2025/03/07/Java%E5%9F%BA%E7%A1%80/IO%E6%B5%81/" title="IO流">IO流</a><time datetime="2025-03-07T08:13:04.000Z" title="发表于 2025-03-07 16:13:04">2025-03-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/07/%E6%8F%92%E4%BB%B6/mybatis-plus%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" title="mybatis-plus插件使用"><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200028419.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mybatis-plus插件使用"/></a><div class="content"><a class="title" href="/2025/03/07/%E6%8F%92%E4%BB%B6/mybatis-plus%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" title="mybatis-plus插件使用">mybatis-plus插件使用</a><time datetime="2025-03-07T01:55:42.000Z" title="发表于 2025-03-07 09:55:42">2025-03-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/03/07/%E6%8F%92%E4%BB%B6/lombok%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" title="lombok插件使用"><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200027954.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="lombok插件使用"/></a><div class="content"><a class="title" href="/2025/03/07/%E6%8F%92%E4%BB%B6/lombok%E6%8F%92%E4%BB%B6%E4%BD%BF%E7%94%A8/" title="lombok插件使用">lombok插件使用</a><time datetime="2025-03-07T01:51:11.000Z" title="发表于 2025-03-07 09:51:11">2025-03-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By moru</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.3</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://caigui88.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>