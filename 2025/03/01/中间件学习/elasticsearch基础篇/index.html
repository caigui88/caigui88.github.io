<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>es 基础篇 | Moru</title><meta name="author" content="moru"><meta name="copyright" content="moru"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Elasticsearch学习  官方文档，学习过程中遇到任何问题首先是尝试从官方文档中查找解决方法，同时也可以加深自己对技术特性的了解  Elasticsearch 生态丰富 elasticsearch 生态丰富，包含一系列工具和功能，帮助用户处理、分析和可视化数据， 核心组成为：  Elasticsearch：核心搜索引擎，负责存储、索引和搜索数据 Kibana：可视化平台、用于查询、分析和展">
<meta property="og:type" content="article">
<meta property="og:title" content="es 基础篇">
<meta property="og:url" content="http://example.com/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/index.html">
<meta property="og:site_name" content="Moru">
<meta property="og:description" content="Elasticsearch学习  官方文档，学习过程中遇到任何问题首先是尝试从官方文档中查找解决方法，同时也可以加深自己对技术特性的了解  Elasticsearch 生态丰富 elasticsearch 生态丰富，包含一系列工具和功能，帮助用户处理、分析和可视化数据， 核心组成为：  Elasticsearch：核心搜索引擎，负责存储、索引和搜索数据 Kibana：可视化平台、用于查询、分析和展">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/4.jpg">
<meta property="article:published_time" content="2025-03-01T03:35:47.079Z">
<meta property="article:modified_time" content="2025-04-17T02:04:46.950Z">
<meta property="article:author" content="moru">
<meta property="article:tag" content="中间件">
<meta property="article:tag" content="elasticsearch">
<meta property="article:tag" content="基础篇">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/4.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "es 基础篇",
  "url": "http://example.com/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/",
  "image": "http://example.com/img/4.jpg",
  "datePublished": "2025-03-01T03:35:47.079Z",
  "dateModified": "2025-04-17T02:04:46.950Z",
  "author": [
    {
      "@type": "Person",
      "name": "墨儒",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/butterfly-icon.png"><link rel="canonical" href="http://example.com/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'es 基础篇',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(./img/sky.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/./img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(./img/4.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011730967.png" alt="Logo"><span class="site-name">Moru</span></a><a class="nav-page-title" href="/"><span class="site-name">es 基础篇</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">es 基础篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-03-01T03:35:47.079Z" title="发表于 2025-03-01 11:35:47">2025-03-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-17T02:04:46.950Z" title="更新于 2025-04-17 10:04:46">2025-04-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>15分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Elasticsearch学习"><a class="header-anchor" href="#Elasticsearch学习"></a>Elasticsearch学习</h1>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.elastic.co/docs">官方文档</a>，学习过程中遇到任何问题首先是尝试从官方文档中查找解决方法，同时也可以加深自己对技术特性的了解</p>
</blockquote>
<h2 id="Elasticsearch-生态丰富"><a class="header-anchor" href="#Elasticsearch-生态丰富"></a>Elasticsearch 生态丰富</h2>
<p>elasticsearch 生态丰富，包含一系列工具和功能，帮助用户处理、分析和可视化数据，</p>
<p>核心组成为：</p>
<ul>
<li>Elasticsearch：核心搜索引擎，负责存储、索引和搜索数据</li>
<li>Kibana：可视化平台、用于查询、分析和展示 Elasticsearch 中的数据</li>
<li>Logstash：数据处理管道，负责数据收集、过滤、增强和传输到 Elasticsearch。</li>
<li>Beats：轻量级的数据传输工具，收集和发生数据到 Logstash 或 Elasticsearch</li>
</ul>
<h2 id="核心概念"><a class="header-anchor" href="#核心概念"></a>核心概念</h2>
<ul>
<li><strong>索引 index</strong>：类似于关系型数据库中的表，索引是数据存储和搜索的 <strong>基本单位</strong>，每个索引可以存储多条文档数据</li>
<li><strong>文档 document</strong>：索引中的每条记录，类似于数据库中的行。以 json 格式存储</li>
<li><strong>字段 field</strong>：文档中的每个键值对，类似于数据库中的列。</li>
<li><strong>映射 mapping</strong>：（类似于 sql 建表语句）用于定义 Elasticsearch 索引中文档字段的数据类型及其处理方式，类似于关系型数据库中的 Schema 表结构，帮助控制字段的存储、索引和查询行为。</li>
<li><strong>集群 cluster</strong>：多个节点组成的群集，用于存储数据并提供搜索功能。集群中的每个节点都可以处理数据。</li>
<li><strong>分片 shard</strong>：为了实现横向扩展，ES 将索引拆分成多个分片，每个分片可以分布在不同节点上。</li>
<li><strong>副本 replica</strong>：分片的复制品，用于提高可用性和容错性。</li>
</ul>
<h2 id="全文检索（分词检索）的原理"><a class="header-anchor" href="#全文检索（分词检索）的原理"></a>全文检索（分词检索）的原理</h2>
<p><strong>分词</strong>：Elasticsearch 的分词器会将输入文本拆解为独立的词条（tokens），方便进行索引和搜索，分词的具体步骤：</p>
<ul>
<li><strong>字符过滤</strong>：去除特殊字符、HTML 标签或进行其他文本清理。</li>
<li><strong>分词</strong>：根据指定的分词器（analyzer），将文本按规则拆分为一个个词条，如：英文可以按空格、中文使用专门的分词器处理</li>
<li><strong>词汇过滤</strong>：对分词结果进行过滤，如：去掉停用词（无意义的词，如：“the”，“is”等）或进行词形归并（如：将动词变为原形）。</li>
</ul>
<p>Elasticsearch 内置了很多分词器，比如按照空格分词等，默认只支持英文，详见<a target="_blank" rel="noopener" href="https://www.elastic.co/docs">官方文档</a>。</p>
<p><strong>倒排索引</strong>：</p>
<p>倒排索引是 Elasticsearch 实现高效搜索的核心数据结构。将文档中的词条映射到文档 ID ，实现快速查找。</p>
<p>原理：</p>
<ul>
<li>每个文档在被索引时，分词器会将文档内容拆解为多个词条。</li>
<li>而后，Elasticsearch 为每个词条生成一个倒排索引，记录该词条在哪些文档中出现。</li>
</ul>
<h2 id="打分规则"><a class="header-anchor" href="#打分规则"></a>打分规则</h2>
<p>搜索到内容的同时要把和用户搜索最相关的内容展示在前面，因此需要引入打分规则。</p>
<p>打分规则(_Score)是用于衡量每个文档与查询条件的匹配度的评分机制，搜索结果的默认排序方式是按性关系得分(__Source)从高到低。</p>
<p>采用的是 <strong>BM25</strong> 算法来计算每个文档的得分，是基于词频、反向文档频率、文档长度等因素来评估文档和查询的相关性。</p>
<p>影响得分的主要因素：</p>
<ul>
<li><strong>词频 TF,Term Frequency</strong>：查询词在文档中出现的次数，出现次数越多，得分越高</li>
<li><strong>反向文档频率 IDF,Inverse document frequency</strong>：查询词在文档中出现的频率，词在越少的文档中出现，IDF 值越高，得分越高。</li>
<li><strong>文档长度</strong>：较短的文档被认为更有相关性，因为查询词在短文档中占的比例更大。</li>
</ul>
<h2 id="ES-查询语法"><a class="header-anchor" href="#ES-查询语法"></a>ES 查询语法</h2>
<p>Elasticsearch 支持多种查询语法，用于不同的场景和需求，主要包括查询 DSL, EQL, SQL 等。</p>
<h3 id="DSL-查询（Domain-Specific-Language）"><a class="header-anchor" href="#DSL-查询（Domain-Specific-Language）"></a>DSL 查询（Domain Specific Language）</h3>
<p>基于 JSON 的查询语言，是 Elasticsearch 中最常见的查询方式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">			<span class="attr">&quot;message&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Elasticsearch 功能性强&quot;</span></span><br><span class="line">		<span class="punctuation">&#125;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>查询会对 message 字段进行分词，并查找包括 “Elasticsearch” 和 “功能” 词条的文档。</p>
<h3 id="EQL-Event-Query-Language"><a class="header-anchor" href="#EQL-Event-Query-Language"></a>EQL Event Query Language</h3>
<p>用于检测和检索时间序列 事件 的查询语言，常用于日志和安全监控场景</p>
<h3 id="SQL-查询"><a class="header-anchor" href="#SQL-查询"></a>SQL 查询</h3>
<p>支持传统 SQL 数据库查询语法</p>
<h2 id="Elasticsearch-常见的查询条件"><a class="header-anchor" href="#Elasticsearch-常见的查询条件"></a>Elasticsearch 常见的查询条件</h2>
<table>
<thead>
<tr>
<th>查询条件</th>
<th>介绍</th>
<th>示例</th>
<th>用法</th>
</tr>
</thead>
<tbody>
<tr>
<td>match</td>
<td>用于全文检索，将查询字符串进行分词并匹配文档中对应的字段</td>
<td></td>
<td>适用于全文检索，分词后匹配文档内容。</td>
</tr>
<tr>
<td>term</td>
<td>精确匹配查询，不进行分词，通常用于结构化数据的精确匹配，如数字，日期，关键字等。</td>
<td></td>
<td>适用于字段的精确匹配，如状态、ID、布尔值等。</td>
</tr>
<tr>
<td>terms</td>
<td>匹配多个值中的任意一个，相当于多个 term 查询的组合</td>
<td></td>
<td>适用于多值匹配的场景。</td>
</tr>
<tr>
<td>range</td>
<td>范围查询，常用于数字，日期字段，支持大于get，小于let，区间等查询</td>
<td></td>
<td>适用于数值或日期的范围查询。</td>
</tr>
<tr>
<td>bool</td>
<td>组合查询，通过 must , should , must_not 等组合多个查询条件</td>
<td></td>
<td>适用于复杂的多条件查询，可以灵活组合。</td>
</tr>
<tr>
<td>wildcard</td>
<td>通配符查询，支持 * 和 ? ，匹配任意字符和匹配单个字符</td>
<td></td>
<td>适用于部分匹配的查询，如模糊搜索。</td>
</tr>
<tr>
<td>prefix</td>
<td>前缀查询，匹配以指定前缀开头的字段内容</td>
<td></td>
<td>适用于查找以指定字符串开头的内容。</td>
</tr>
<tr>
<td>fuzzy</td>
<td>模糊查询，允许指定程度的拼写错误或字符替换</td>
<td></td>
<td>适用于处理拼写错误或不完全匹配的查询。</td>
</tr>
<tr>
<td>exists</td>
<td>查询字段是否存在</td>
<td></td>
<td>适用于查找字段存在或缺失的文档。</td>
</tr>
<tr>
<td>match_phrase</td>
<td>短语匹配查询，要求查询的词语按顺序完全匹配</td>
<td></td>
<td>适用于严格的短语匹配，词语顺序和距离都严格控制。</td>
</tr>
<tr>
<td>match_all</td>
<td>匹配所有文档</td>
<td></td>
<td>适用于查询所有文档，通常与分页配合使用。</td>
</tr>
<tr>
<td>ids</td>
<td>基于文档 ID 查询，支持查询特定 ID 的文档</td>
<td></td>
<td>适用于根据文档 ID 查找特定文档。</td>
</tr>
<tr>
<td>geo_distance</td>
<td>地理位置查询，基于地理坐标和指定距离查询</td>
<td></td>
<td>适用于根据距离计算查找地理位置附近的文档。</td>
</tr>
<tr>
<td>aggregations</td>
<td>聚合查询，用于统计、计算和分组查询，类似于 SQL 中的 group_by</td>
<td></td>
<td>适用于统计和分析数据，比如求和、平均值、最大值等。</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>：</p>
<ul>
<li>精确匹配 vs. 全文检索：term 精确匹配，不分词；match 全文检索，会对查询词进行分词</li>
<li>组合查询：bool 查询可以灵活组合多个条件，适用于复杂的查询需求</li>
<li>模糊查询：fuzzy 和 wildcard 提供了灵活的模糊匹配方式，适用于拼写错误或不完全匹配场景。</li>
</ul>
<h2 id="ES-数据同步方案"><a class="header-anchor" href="#ES-数据同步方案"></a>ES 数据同步方案</h2>
<p>一般情况下，如果做查询搜索功能，使用 ES 来模糊搜索，但是数据是存放在数据库 MYSQL 中的，所以需要把 MYSQL 中的数据和 ES 进行同步，保证数据一致（以 MYSQL 为主）</p>
<p>数据流向：MYSQL =&gt; ES 单向</p>
<p>数据同步 2 个过程：全量同步（第一次） + 增量同步（更新数据）</p>
<h3 id="4-种主流方案："><a class="header-anchor" href="#4-种主流方案："></a>4 种主流方案：</h3>
<h4 id="定时任务"><a class="header-anchor" href="#定时任务"></a>定时任务</h4>
<p>固定xx分钟同步 1 次</p>
<ul>
<li>优：
<ul>
<li>简单、易于开发、部署、维护</li>
<li>占用资源少，无需引入复杂的第三方中间件</li>
<li>不用处理复杂的并发和实时性问题</li>
</ul>
</li>
<li>缺
<ul>
<li><strong>有时间差</strong>：无法做到实时同步，数据存在滞后</li>
<li>数据频繁变化时，无法确保数据完全同步，任意出现错过更新的情况</li>
<li>对大数据量的更新处理不够高效，可能会引入重复更新逻辑</li>
</ul>
</li>
<li>场景：
<ul>
<li>数据实时性要求不高</li>
<li>数据几乎不发生修改</li>
<li>数据容忍丢失</li>
</ul>
</li>
</ul>
<h4 id="双写"><a class="header-anchor" href="#双写"></a>双写</h4>
<p>写数据时，必须同时写 ES；更新删除数据库也同理</p>
<p>可以通过事务保持数据一致性，使用事务时，先保证 MYSQL 写成功，因为 ES 没有回滚功能，可以通过定时任务 + 日志 + 告警进行检测和修复（补偿）</p>
<ul>
<li>优：
<ul>
<li>简单，业务逻辑直接控制数据同步</li>
<li>可以利用事务部分保证 MYSQL 和 ES 的数据一致性</li>
<li>同步的时延较短，理论上做到实时更新 ES</li>
</ul>
</li>
<li>缺：
<ul>
<li>影响性能，因为操作 MYSQL 时也需要操作 ES。</li>
<li>一致性问题，如果 ES 写入失败，MYSQL 事务提交后，ES 可能丢失数据；或 ES 写入成功，但 MYSQL 事务提交失败，ES 无法回滚。因此需要引入额外的监控、补偿机制来检测同步失败的情况（定时任务、日志和告警修复）</li>
<li>代码复杂，需要对每一个写操作都进行<strong>双写</strong>处理</li>
</ul>
</li>
</ul>
<h4 id="用-Logstash-数据同步管道"><a class="header-anchor" href="#用-Logstash-数据同步管道"></a>用 Logstash 数据同步管道</h4>
<p>配合 Kafka 信息队列 +  beats 采集器：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011219736.png" alt="image-20250301121950666"></p>
<ul>
<li>
<p><strong>优</strong>:</p>
<ul>
<li><strong>配置驱动</strong>：基于配置文件，减少了手动编码，数据同步逻辑和业务代码解耦。</li>
<li><strong>扩展性好</strong>：可以灵活引入 Kafka 等消息队列实现异步数据同步，并可处理高吞吐量数据。</li>
<li>支持多种数据源：Logstash 支持丰富的数据源，方便扩展其他同步需求。</li>
</ul>
</li>
<li>
<p><strong>缺</strong>:</p>
<ul>
<li><strong>灵活性差</strong>：需要通过配置文件进行同步，复杂的业务逻辑可能难以在配置中实现，无法处理细粒度的定制化需求。</li>
<li>引入额外组件，维护成本高:通常需要引入 Kafka、Beats 等第三方组件，增加了系统的复杂性和运维成本。</li>
</ul>
</li>
<li>
<p>应用场景:</p>
<ul>
<li><strong>大数据同步</strong>：适合大规模、分布式数据同步场景。</li>
<li><strong>对实时性要求不高</strong>适合数据流处理或延迟容忍较大的系统,</li>
<li>系统已有 Kafka 或类似的消息队列架构:如果系统中已经使用了 Kafka 等中间件，使用 Logstash 管道会变得很方便。</li>
</ul>
</li>
</ul>
<h4 id="监听-MYSQL-Binlog"><a class="header-anchor" href="#监听-MYSQL-Binlog"></a>监听 MYSQL Binlog</h4>
<p>有任何数据变更时都能够实时监听到，并且同步到 Elasticsearch，一般不需要自己监听，可以使用现成的技术，如 Canal。</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011225501.png" alt="image-20250301122512429"></p>
<p>Canal 核心原理：数据库每次修改时，会修改 binlog 文件，只需要监听文件的修改，就能第一时间得到信息并处理</p>
<ul>
<li>优：
<ul>
<li><strong>实时性强</strong>：能够在 MYSQL 数据发生变更的第一时间同步到 ES，做到真正的实时同步</li>
<li>轻量级：Binlog 时数据库自带的日志功能，不需要修改核心业务代码，只需要新增监听逻辑</li>
</ul>
</li>
<li>缺：
<ul>
<li>引入外部依赖：需要引入像 Canal 这类中间件，增加了系统复杂性和维护成本</li>
<li>运维难度增加：需要确保 Canal 或其他监听器的稳定运行，并且对 MYSQL 的 binlog 配置要求较高</li>
<li>一致性问题：如果 Canal 服务出现问题或暂停，数据可能会滞后或丢失，必须设计补偿机制。</li>
</ul>
</li>
<li>场景：
<ul>
<li>实时同步要求高：高并发，高数据一致性要求</li>
<li>数据频繁变化：数据变更频繁且需要高效增量同步</li>
</ul>
</li>
</ul>
<h2 id="分词器"><a class="header-anchor" href="#分词器"></a>分词器</h2>
<p>ES 自带的分词器只支持英文分词，因此需要多安装一个中文分词器 IK 分词器，IK 分词器提供了两个分词器： ik_smart 和 ik_max_word。</p>
<ul>
<li>ik_smart 是智能分词，尽量选择最像 “词” 的拆分方式，如：“好学生” 会被识别为一个词。
<ul>
<li>适用于<strong>搜索分词</strong>，即查询时使用，保证性能同时提供合理的分词精度。</li>
</ul>
</li>
<li>ik_max_word 是尽可能分词，可以包括组合词，比如：“好学生” 会被识别为 3 个词：好学生，好学，学生
<ul>
<li>适用于<strong>底层索引分词</strong>，确保在建立索引时尽可能多地分词，提高查询时的匹配度和覆盖面。</li>
</ul>
</li>
</ul>
<p>更多详见<a target="_blank" rel="noopener" href="https://github.com/infinilabs/analysis-ik">analysis-ik 官方文档</a>。</p>
<h2 id="设计-ES-索引"><a class="header-anchor" href="#设计-ES-索引"></a>设计 ES 索引</h2>
<p>为了将 MySQL 题目表数据导入到 Elasticsearch 中并实现分词搜索,需要为 ES 索引定义 mapping。ES 的 mapping 用于定义字段的类型、分词器及其索引方式。<br>
相当于数据库的建表，数据库建表时我们要考虑索引，同样 Elasticsearch 建立索引时，要考虑到字段选取、分词器、字段格式等问题。</p>
<p>在实际操作中即根据数据库表的字段去设计 mapping ，</p>
<ol>
<li>考虑哪些字段需要作为 mapping 里的一个 properties。</li>
<li>考虑作为 properties 的字段的 “type”，“analyzer”，“search_analyzer”（在使用 IK 分词器时，则是建立索引用 ik_max_word，查询用 ik_smart）</li>
</ol>
<p>在面试鸭项目中 ，建立题目 mapping 如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;answer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;search_analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;long&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;editTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;updateTime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isDelete&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>注意事项</strong>：</p>
<ul>
<li>
<p>title，content，answer：</p>
<p>这些字段被定义为 text 类型，适合存储较长的、需要全文搜索的内容。由于会有中文内容，所以使用 IK 中文分词器进行分词处理，提高查询的灵活性和匹配度。</p>
<ul>
<li><code>&quot;analyzer&quot;: &quot;ik_max_word&quot;</code>：用于索引时进行最大粒度的分词，生成较多词语，适合查询时提高召回率。</li>
<li><code>&quot;search_analyzer&quot;: &quot;ik_smart&quot;</code>：用于搜索时进行较智能的分词，生成较少的词语，用于提高搜索精度。</li>
</ul>
</li>
<li>
<p>使用 title.keyword：为 title 字段增加一个子字段 keyword，用于存储未分词的标题，支持精确匹配。还配置了 ignore_above: 256，表示如果 title 字段长度超过 256 个字符，将不会为 keyword 字段进行索引，避免过长文本导致性能问题。</p>
</li>
<li>
<p>tags：标签通常是预定义的、用于分类或标签筛选的关键字，通常不需要分词。设置为 keyword 类型以便支持精确匹配和聚合操作(例如统计某标签的出现频次)。 keyword 不进行分词，因此适合存储不变的、结构化的数据。</p>
</li>
<li>
<p>userid:用来唯一标识用户的数值字段。在 Elasticsearch 中，数值类型(如 1ong)非常适合用于精确査询、排序和范围过滤。与字符串相比，数值类型的查询和存储效率更高，尤其是对于大量用户数据的查询。</p>
</li>
<li>
<p>editTime、createTime、updateTime:时间字段被定义为 date 类型，并指定了格式 “yyyy-MM-dd HH:mm:ss”。这样做的好处是 Elasticsearch 可以基于这些字段进行时间范围査询、排序和聚合操作，如按时间过滤或统计某时间段的数据。</p>
</li>
<li>
<p>isDelete:使用 keyword 类型，表示是否被删除。 因为 keyword 是为精确匹配设计的，适用于枚举值精确查询的场景，性能好且清晰。</p>
<p>为什么不用 boolean 类型呢？因为 MySQL数据库存储的是 0 和 1，写入 ES 时需要转换类型。</p>
</li>
</ul>
<h3 id="无需显式指定-id-字段"><a class="header-anchor" href="#无需显式指定-id-字段"></a>无需显式指定 id 字段</h3>
<p>Elasticsearch 中，每个文档都有一个唯一的 _id 字段来标识文档，该字段用于文档的主键索引和唯一标识，通常开发者无需显式定义 id 字段（也可以在插入数据时手动指定 _id）。</p>
<h3 id="tags-支持数组"><a class="header-anchor" href="#tags-支持数组"></a>tags 支持数组</h3>
<p>Elasticsearch 中，所有到字段类型（包括 keyword 和 text）都默认支持数组。可以直接插入一个包含多个值的数组，Elasticsearch 会自动将其视为多个值的集合。</p>
<p>查询时，Elasticsearch 会将数组中的每个值视为独立的 keyword ，可以进行精确匹配。</p>
<h2 id="扩展"><a class="header-anchor" href="#扩展"></a>扩展</h2>
<h3 id="TODO-根据具体业务自定义-ES-词典，提高分词准确度"><a class="header-anchor" href="#TODO-根据具体业务自定义-ES-词典，提高分词准确度"></a>TODO 根据具体业务自定义 ES 词典，提高分词准确度</h3>
<p>根据官方文档，得知只需在文件 <code>IKAnalyzer.cfg.xml</code> 中添加词典即可根据业务定义 IK 分词词典，提高分词准确度</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011225011.png" alt="image-20250301122540945"></p>
<p>如上我添加了词典 <code>monkey.dic</code> 内容如下：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011225452.png" alt="image-20250301122533399"></p>
<p>分词效果由原来的：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011225028.png" alt="image-20250222160004958"></p>
<p>修正为：</p>
<p><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503011226058.png" alt="image-20250222155915135"></p>
<h3 id="TODO-使用-ES-查询时，关联获取题目的动态数据"><a class="header-anchor" href="#TODO-使用-ES-查询时，关联获取题目的动态数据"></a>TODO 使用 ES 查询时，关联获取题目的动态数据</h3>
<p>首先从 es 读取数据，而后对 es 读取的数据进行校验和更新，如果有需要进行修改的数据也可以在迭代器中进一步进行修改，从而达到获取题目的动态数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复用 MySQL / MyBatis Plus 的分页对象，封装返回结果</span></span><br><span class="line">        Page&lt;Question&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;();</span><br><span class="line">        List&lt;Question&gt; resourceList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (searchHits.hasSearchHits()) &#123;</span><br><span class="line">            List&lt;SearchHit&lt;QuestionEsDTO&gt;&gt; searchHitList = searchHits.getSearchHits();</span><br><span class="line">            List&lt;Long&gt; questionIdList = searchHitList.stream()</span><br><span class="line">                    .map(searchHit -&gt; searchHit.getContent().getId())</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            List&lt;Question&gt; questionList = questionMapper.selectBatchIds(questionIdList);</span><br><span class="line">            <span class="keyword">if</span>(questionList != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">// 建立 Map 快速确认 es 是否有滞后数据</span></span><br><span class="line">                Map&lt;Long, List&lt;Question&gt;&gt; idQuestionMap = questionList.stream().collect(Collectors.groupingBy(Question::getId));</span><br><span class="line"></span><br><span class="line">                Iterator&lt;SearchHit&lt;QuestionEsDTO&gt;&gt; iterator = searchHitList.iterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext())&#123;</span><br><span class="line">                    SearchHit&lt;QuestionEsDTO&gt; searchHit = iterator.next();</span><br><span class="line">                    <span class="type">Long</span> <span class="variable">questionId</span> <span class="operator">=</span> searchHit.getContent().getId();</span><br><span class="line">                    <span class="keyword">if</span>(idQuestionMap.containsKey(questionId))&#123;</span><br><span class="line">                        <span class="type">Question</span> <span class="variable">question</span> <span class="operator">=</span> idQuestionMap.get(questionId).get(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">if</span>(question.getIsDelete().equals(<span class="number">0</span>))</span><br><span class="line">                            log.info(<span class="string">&quot;实时更新数据&quot;</span>);</span><br><span class="line">                        <span class="keyword">else</span>&#123;</span><br><span class="line">                            iterator.remove();</span><br><span class="line">                            <span class="type">String</span> <span class="variable">delete</span> <span class="operator">=</span> elasticsearchRestTemplate.delete(String.valueOf(questionId), QuestionEsDTO.class);</span><br><span class="line">                            log.info(<span class="string">&quot;数据已被软删除，delete question &#123;&#125;&quot;</span>, delete);</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//如果被物理或逻辑删除，则需要从 es 中删除滞后的数据</span></span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        iterator.remove();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">delete</span> <span class="operator">=</span> elasticsearchRestTemplate.delete(String.valueOf(questionId), QuestionEsDTO.class);</span><br><span class="line">                        log.info(<span class="string">&quot;数据已被硬删除，delete question &#123;&#125;&quot;</span>, delete);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                questionIdList.forEach( questionId -&gt;&#123;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (SearchHit&lt;QuestionEsDTO&gt; questionEsDTOSearchHit : searchHitList) &#123;</span><br><span class="line">                resourceList.add(QuestionEsDTO.dtoToObj(questionEsDTOSearchHit.getContent()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h3 id="TODO-ES-接口支持降级"><a class="header-anchor" href="#TODO-ES-接口支持降级"></a>TODO ES 接口支持降级</h3>
<h3 id="TODO-防止重复执行定时任务"><a class="header-anchor" href="#TODO-防止重复执行定时任务"></a>TODO 防止重复执行定时任务</h3>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">墨儒</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/">http://example.com/2025/03/01/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/elasticsearch%E5%9F%BA%E7%A1%80%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">转载请注明出处</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><a class="post-meta__tags" href="/tags/elasticsearch/">elasticsearch</a><a class="post-meta__tags" href="/tags/%E5%9F%BA%E7%A1%80%E7%AF%87/">基础篇</a></div><div class="post-share"><div class="social-share" data-image="/./img/4.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="支付寶"/></a><div class="post-qr-code-desc">支付寶</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/01/Java%E5%BA%95%E5%B1%82/JVM/" title="jvm 学习笔记"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200026081.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">jvm 学习笔记</div></div><div class="info-2"><div class="info-item-1">JVM  本文参考资料： 黑马程序员JVM虚拟机入门到实战全套视频教程，java大厂面试必会的jvm一套搞定（丰富的实战案例及最热面试题）_哔哩哔哩_bilibili  认识 JVM jvm 全称 java virtual machine 本质是一个运行的程序，核心职责是 运行由 jdk 编译产生的 Java 字节码文件。 jvms三大核心功能：  解释与运行：对字节码文件中的指令实时解释为机器码，交由计算机执行 内存管理：自动为对象、方法分配内存；垃圾回收机制，自动监测和回收不再使用的对象 即时编译：将热点代码翻译为机器码后会将这段机器码存储到内存中，避免重复翻译导致的时耗  常见的 jvm：Hotspot、GraalVM、OpenJ9等，另外 DragonWell 龙井 JDK 也提供了一款功能增强版的 JVM。我们平时默认使用的虚拟机是 Oracle 官方的 HotSpot。 JVM 的组成   类加载器：ClassLoader，作用是把从外界（磁盘或网络）读取的字节码文件加载到内存中   运行时数据区域：负责管理 jvm...</div></div></div></a><a class="pagination-related" href="/2025/03/01/%E5%89%8D%E7%AB%AF/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91/" title="微信小程序开发"><img class="cover" src="/./img/2.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">微信小程序开发</div></div><div class="info-2"><div class="info-item-1">微信小程序开发 开发流程概览 目录结构 小程序主体部分由三个文件组成，必须放在项目的根目录下  app.js：必需存在，小程序的逻辑部分 app.json：必须存在，小程序公共配置 app.wxss：非必需存在，控制小程序的样式  示例图：   一个小程序页面的构成：  js：必需，页面的逻辑 wxml：必需，页面的结构 json：非必需，页面的配置 wxss：非必需，页面的样式表  </div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E5%9F%BA%E7%A1%80%E7%AF%87/" title="rabbitmq 基础篇"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-05</div><div class="info-item-2">rabbitmq 基础篇</div></div><div class="info-2"><div class="info-item-1">rabbitMQ 基础篇 参考资料： MQ入门-01.MQ课程介绍_哔哩哔哩_bilibili RabbitMQ 官方文档 RabbitMQ 常见问题与故障排查-CSDN博客 背景引入 一款高性能的异步通信组件 同步通信类似于：人和人之间打电话，没办法在同一时间和多个人打电话 异步通信类似于：人和人之间发微信，一个人可以同时和多个人进行聊天，并发能力强 原本的 openFegin 是一个同步操作，发送的请求必须实时等待返回结果，以下面的登录操作为例：  修改成异步通信：  只需要让其他的微服务监听到 MQ...</div></div></div></a><a class="pagination-related" href="/2025/03/05/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/rabbitmq%E9%AB%98%E7%BA%A7%E7%AF%87/" title="rabbitmq 高级篇"><img class="cover" src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202503200029548.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-05</div><div class="info-item-2">rabbitmq 高级篇</div></div><div class="info-2"><div class="info-item-1">rabbitmq 高级篇  假如 MQ 通知失败，那么会出现数据不一致的问题，此时就涉及到了消息可靠性（即消息至少被消费者处理过 1 次），接下来将介绍一些实践中常见的确保消息可靠性的手段 发送者可靠性 发送者重连 有时由于网络波动，可能出现发送者连接 MQ 失败的情况，此时通过配置可以开启连接失败后的重连机制： 123456789spring:  rabbitmq:    connection-timeout: 1s # 设置MQ的连接超时时间    template:      retry:        enabled: true # 开启超时重试机制        initial-interval: 1000ms # 失败后的初始等待时间        multiplier: 1 # 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier        max-attempts: 3 # 最大重试次数 【注：在网络存在不稳定的情况下，重试机制可以提高消息发送的成功率。但 SpringAMQP...</div></div></div></a><a class="pagination-related" href="/2025/03/21/%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AD%A6%E4%B9%A0/sentinel/" title="sentinel"><img class="cover" src="/./img/3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-21</div><div class="info-item-2">sentinel</div></div><div class="info-2"><div class="info-item-1">Sentinel Sentinel 官方文档 前置知识 网络流量控制和熔断 流量安全优化的目标简单概括为：确保数据在传输过程中的机密性、完整性和可用性，防止未授权的访问、篡改、泄漏和攻击，同时提升网络传输效率和性能。 从流量控制和熔断的角度来看，流量安全优化的目标又可以概括为：防止系统过载、保障服务可用性、抵御恶意流量，确保系统能够快速从故障中恢复。 基本概念 Sentinel 的使用可以分为两个部分:  核心库（Jar包）：不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。在项目中引入依赖即可实现服务限流、隔离、熔断等功能。 控制台（Dashboard）：Dashboard 主要负责管理推送规则、监控、管理机器信息等。  流量控制 流量控制是为了防止系统被过多的请求压垮，确保资源合理分配并保持服务的可用性，比如对请求数量的限制、对总的处理量的限制，对整体流量对控制。 流量控制的优势：  防止过载：当瞬间涌入的请求量超出系统处理能力时，会导致资源枯竭，如 CPU...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/./img/butterfly-icon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">moru</div><div class="author-info-description">道虽迩，不行不至</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">69</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/caigui88"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/caigui88" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="/1468664118@qq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text">Elasticsearch学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch-%E7%94%9F%E6%80%81%E4%B8%B0%E5%AF%8C"><span class="toc-number">1.1.</span> <span class="toc-text">Elasticsearch 生态丰富</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2%EF%BC%88%E5%88%86%E8%AF%8D%E6%A3%80%E7%B4%A2%EF%BC%89%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">全文检索（分词检索）的原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%93%E5%88%86%E8%A7%84%E5%88%99"><span class="toc-number">1.4.</span> <span class="toc-text">打分规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES-%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95"><span class="toc-number">1.5.</span> <span class="toc-text">ES 查询语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DSL-%E6%9F%A5%E8%AF%A2%EF%BC%88Domain-Specific-Language%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">DSL 查询（Domain Specific Language）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EQL-Event-Query-Language"><span class="toc-number">1.5.2.</span> <span class="toc-text">EQL Event Query Language</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.5.3.</span> <span class="toc-text">SQL 查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Elasticsearch-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.6.</span> <span class="toc-text">Elasticsearch 常见的查询条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.</span> <span class="toc-text">ES 数据同步方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%A7%8D%E4%B8%BB%E6%B5%81%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-number">1.7.1.</span> <span class="toc-text">4 种主流方案：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">定时任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8C%E5%86%99"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">双写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8-Logstash-%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E7%AE%A1%E9%81%93"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">用 Logstash 数据同步管道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC-MYSQL-Binlog"><span class="toc-number">1.7.1.4.</span> <span class="toc-text">监听 MYSQL Binlog</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.8.</span> <span class="toc-text">分词器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1-ES-%E7%B4%A2%E5%BC%95"><span class="toc-number">1.9.</span> <span class="toc-text">设计 ES 索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%9C%80%E6%98%BE%E5%BC%8F%E6%8C%87%E5%AE%9A-id-%E5%AD%97%E6%AE%B5"><span class="toc-number">1.9.1.</span> <span class="toc-text">无需显式指定 id 字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tags-%E6%94%AF%E6%8C%81%E6%95%B0%E7%BB%84"><span class="toc-number">1.9.2.</span> <span class="toc-text">tags 支持数组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-number">1.10.</span> <span class="toc-text">扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TODO-%E6%A0%B9%E6%8D%AE%E5%85%B7%E4%BD%93%E4%B8%9A%E5%8A%A1%E8%87%AA%E5%AE%9A%E4%B9%89-ES-%E8%AF%8D%E5%85%B8%EF%BC%8C%E6%8F%90%E9%AB%98%E5%88%86%E8%AF%8D%E5%87%86%E7%A1%AE%E5%BA%A6"><span class="toc-number">1.10.1.</span> <span class="toc-text">TODO 根据具体业务自定义 ES 词典，提高分词准确度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TODO-%E4%BD%BF%E7%94%A8-ES-%E6%9F%A5%E8%AF%A2%E6%97%B6%EF%BC%8C%E5%85%B3%E8%81%94%E8%8E%B7%E5%8F%96%E9%A2%98%E7%9B%AE%E7%9A%84%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">1.10.2.</span> <span class="toc-text">TODO 使用 ES 查询时，关联获取题目的动态数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TODO-ES-%E6%8E%A5%E5%8F%A3%E6%94%AF%E6%8C%81%E9%99%8D%E7%BA%A7"><span class="toc-number">1.10.3.</span> <span class="toc-text">TODO ES 接口支持降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TODO-%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.10.4.</span> <span class="toc-text">TODO 防止重复执行定时任务</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/04/21/%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%93%E4%B8%9A%E8%AF%BE/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="软件测试"><img src="/./img/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="软件测试"/></a><div class="content"><a class="title" href="/2025/04/21/%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%93%E4%B8%9A%E8%AF%BE/%E8%BD%AF%E4%BB%B6%E6%B5%8B%E8%AF%95%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="软件测试">软件测试</a><time datetime="2025-04-21T13:28:31.000Z" title="发表于 2025-04-21 21:28:31">2025-04-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/" title="树状数组"><img src="/./img/3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="树状数组"/></a><div class="content"><a class="title" href="/2025/04/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/" title="树状数组">树状数组</a><time datetime="2025-04-15T04:47:39.000Z" title="发表于 2025-04-15 12:47:39">2025-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%BA%BF%E6%AE%B5%E6%A0%91/" title="线段树"><img src="/./img/4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="线段树"/></a><div class="content"><a class="title" href="/2025/04/15/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%BA%BF%E6%AE%B5%E6%A0%91/" title="线段树">线段树</a><time datetime="2025-04-15T04:40:24.000Z" title="发表于 2025-04-15 12:40:24">2025-04-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/03/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="动态规划"><img src="https://blog-caigui88.oss-cn-shenzhen.aliyuncs.com/imgs/202504281520603.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="动态规划"/></a><div class="content"><a class="title" href="/2025/04/03/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="动态规划">动态规划</a><time datetime="2025-04-03T05:08:18.000Z" title="发表于 2025-04-03 13:08:18">2025-04-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/04/01/Java/FreeMarker/" title="FreeMarker"><img src="/./img/2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="FreeMarker"/></a><div class="content"><a class="title" href="/2025/04/01/Java/FreeMarker/" title="FreeMarker">FreeMarker</a><time datetime="2025-04-01T08:37:43.000Z" title="发表于 2025-04-01 16:37:43">2025-04-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By moru</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.3</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://caigui88.github.io/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>